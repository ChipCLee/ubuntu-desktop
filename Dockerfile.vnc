FROM kasmweb/desktop:ubuntu-jammy

USER root
ADD ./libfranka-sim /libfranka-sim
# Install desktop environment extras; keep image slim
RUN sudo apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        nano \
        git \
    && sudo apt-get clean \
    && sudo rm -rf /var/lib/apt/lists/*

USER kasm-user
# Install uv into /usr/local/bin so it's on PATH in every layer
ENV UV_INSTALL_DIR=/usr/local/bin
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

WORKDIR /libfranka-sim
# Create the virtual environment and install dependencies with uv
RUN uv venv
# RUN --mount=type=cache,target=/root/.cache/uv \
#RUN uv sync --frozen --no-dev --no-install-project --python .venv/bin/python
RUN uv sync --python .venv/bin/python
RUN uv pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
RUN uv pip install -e .
